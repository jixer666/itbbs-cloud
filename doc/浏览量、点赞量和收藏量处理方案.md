# 浏览量、点赞量和收藏量处理方案

## 浏览量方案

浏览量有两个概念：

- PV：每次页面被刷新都计数
- UV：同一用户在统计周期内只计一次

前台文章的浏览量属于 PV，后台统计分析数据适用于 UV，这里只处理 PV 情况

**技术实现**：采用 Redis 的 string 结构来存储浏览量，为了防止恶意刷浏览量，使用 Lua 脚本对新增浏览量做限流

浏览量出现的场景：

- **首页查询文章列表**：查询文章列表采用的是模糊统计，比如有1234个浏览量，只会显示1.2k，所以这里允许出现稍许数据不一致的偏差，就直接返回的是数据库中的浏览量

- **查询具体文章详细信息**：获取 Redis 中缓存的浏览量的数据，若数据不存在，就从数据库中获取，然后缓存在 Redis 中并设置有效期为24小时

- **新增浏览量**：页面刷新通过 `redisTemplate.opsForValue().increment` 来实现自增，每次新增都会刷新 Redis Key 的有效期为24小时（在自增前需要校验缓存是否过期，若不存在还需要加载缓存），此外用定时任务每隔10秒去批量查找这10秒内待处理的数据集合，然后聚合在一起发送 MQ 更新数据库中文章的浏览量

## 点赞量和收藏量方案

点赞和收藏都是同一个思想，每个人都只能执行一次，无法多次点赞或多次收藏

**技术实现**：采用 Redis 的 string 结构来存储点赞量或浏览量，zset 结构来存储用户点赞或收藏的集合，zset 最大长度为9999，超过这个范围就选择抛弃第一个元素，考虑一个用户每天顶多了点赞10个，几年也用不完，会发现哔哩哔哩这种几年前点赞的视频会失效，我们任然可以重新点赞也是这个原理

点赞量和收藏量出现的场景：

- **首页查询文章列表**：同上方浏览量

- **查询具体文章详细信息**：同上方浏览量

- **新增点赞量或收藏量**：点击点赞或收藏，需要执行：`点赞或浏览+1/-1 -> 加入到计数定时任务(10s) -> 加入到待同步记录定时任务(60s)`，这三部操作均是在一个 Lua 脚本保证原子性，定时任务聚合一定量的任务后发送 MQ 消费


参考文章：[B站千亿级点赞系统服务架构设计 - 哔哩哔哩](https://www.bilibili.com/opus/758312609901445367)

