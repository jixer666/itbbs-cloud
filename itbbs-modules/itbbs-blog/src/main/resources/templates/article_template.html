<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="article-id" th:content="${articleId}">
    <meta name="author-id" th:content="${userId}">
    <meta name="price" th:content="${price}">
    <meta name="visible-range" th:content="${visibleRange}">
    <meta name="full-content-request-path" th:content="${fullContentRequestPath}">
    <title th:text="${title} ? ${title} + ' - ITBBS' : 'ITBBS文章'"></title>
    <link rel="stylesheet" href="http://oss.itbbs.com/static/css/all-min.css">
    <link rel="stylesheet" href="http://oss.itbbs.com/static/css/element-ui.css">
    <script src="http://oss.itbbs.com/static/js/vue.js"></script>
    <script src="http://oss.itbbs.com/static/js/element-ui.js"></script>
    <link rel="stylesheet" href="http://oss.itbbs.com/static/css/article.css">

    <style></style>
</head>
<body>

<div id="app" v-cloak>
    <!-- 顶部导航组件 -->
    <nav-bar :user-avatar="currentUser.avatar"></nav-bar>

    <!-- 确认订单弹窗 -->
    <el-dialog title="确认订单" :visible.sync="orderConfirmDialogVisible" width="500px" @close="closeOrderConfirmDialog">
        <div v-if="orderConfirmInfo">
            <p><strong>订单编号：</strong>{{ orderConfirmInfo.orderSn }}</p>
            <p><strong>订单类型：</strong>{{ orderConfirmInfo.orderType === 1 ? '文章付费' : '其他' }}</p>
            <p><strong>总金额：</strong>¥{{ orderConfirmInfo.totalAmount }}</p>
            <p><strong>商品详情：</strong></p>
            <ul>
                <li v-for="item in orderConfirmInfo.orderItemList" :key="item.orderItemId">
                    {{ item.productName }} - ¥{{ item.productPrice }} x {{ item.productQuantity }}
                </li>
            </ul>
        </div>
        <div slot="footer" class="dialog-footer">
            <el-button @click="closeOrderConfirmDialog">取消</el-button>
            <el-button type="primary" @click="submitOrder">确认下单</el-button>
        </div>
    </el-dialog>

    <div class="main-container">
        <!-- 左侧悬浮组件 -->
        <left-toolbox :stats="articleStats" :id="articleId" v-loading="articleMetaLoading"></left-toolbox>

        <!-- 中间文章组件 -->
        <div class="article-area">
            <div class="article-title-box">
                <h1 class="title-article" th:text="${title}">文章标题</h1>
            </div>

            <div class="article-info-box">
                <div class="article-bar-top">
                  <span class="article-type-img" th:text="${type == 1 ? '原创' : (type == 2 ? '转载' : '翻译')}">
                    原创
                  </span>
                    <div class="article-copyright">
                        <span class="author-name" th:text="${userInfo.nickname}">作者名</span>
                        <span style="margin: 0 10px;">|</span>
                        <span th:text="${#dates.format(createTime, 'yyyy-MM-dd HH:mm:ss')}">发布时间</span>
                    </div>
                </div>
                <div class="read-count" v-loading="articleMetaLoading">
                    <i class="fa fa-eye"></i> <span>{{ articleStats.viewsCount }}</span> 阅读
                    <span style="margin-left:10px;"><i class="fa fa-thumbs-up"></i> <span>{{ articleStats.likeCount }}</span> 点赞</span>
                    <span style="margin-left:10px;"><i class="fa fa-heart"></i> <span>{{ articleStats.collectCount }}</span> 收藏</span>
                </div>
            </div>

            <p class="tags-row">
                文章标签：
                <span th:each="tag : ${tagDetailsList}" th:text="'#' + ${tag}" class="tag-item"></span>
            </p>

            <div>
                <div id="content_views" th:utext="${previewContent}"></div>
                <div class="preview-footer" v-if="!articleStats.isPayment">
                    <div class="preview-tip">
                        本文为付费内容，购买后查看全文
                    </div>
                    <div>
                        <button @click="handleSubscribe" class="subscribe-btn" :loading="subscribeBtnLoading">购买解锁全文</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- 右侧侧边栏组件 -->
        <right-sidebar
                :author-child-loading="authorLoading"
                :toc-child-items="tocItems"
                :author="authorInfo"
                :hot-list="hotArticles">
        </right-sidebar>
    </div>
</div>

<!-- ================= 组件模板定义 (x-template) ================= -->

<!-- 1. 顶部导航栏模板 -->
<script type="text/x-template" id="tpl-nav-bar">
    <nav class="itbbs-toolbar">
        <div class="toolbar-container">
            <div class="left-part">
                <div class="logo">ITBBS</div>
                <div class="nav-links">
                    <!-- 使用Vue渲染导航项 -->
                    <a :href="item.url" v-for="(item, index) in navItems" :key="index">{{ item.name }}</a>
                </div>
            </div>
            <div class="search-box">
                <input type="text" v-model="searchText" placeholder="搜索博文/代码/用户..." @keyup.enter="handleSearch">
                <i class="fa fa-search search-btn" @click="handleSearch"></i>
            </div>
            <div class="user-actions">
                <a class="btn-write"><i class="fa fa-pen"></i> 创作中心</a>
                <div class="avatar">
                    <img :src="userAvatar" alt="Me">
                </div>
            </div>
        </div>
    </nav>
</script>

<!-- 2. 左侧悬浮栏模板 -->
<script type="text/x-template" id="tpl-left-toolbox">
    <aside class="left-toolbox">
        <div class="tool-item" @click="handleLike">
            <i class="fa fa-thumbs-up" :class="{active: stats.isLiked}"></i>
            <span>{{ stats.likeCount }}</span>
        </div>
        <div class="tool-item">
            <i class="fa fa-comment-dots"></i>
            <span>{{ stats.commentCount }}</span>
        </div>
        <div class="tool-item" @click="handleCollect">
            <i class="fa fa-star" :class="{active: stats.isCollected}"></i>
            <span>{{ stats.collectCount }}</span>
        </div>
        <div class="tool-item">
            <i class="fa fa-share-alt"></i>
            <span>分享</span>
        </div>
    </aside>
</script>

<!-- 3. 右侧侧边栏模板 -->
<script type="text/x-template" id="tpl-right-sidebar">
    <aside class="right-sidebar">
        <!-- 作者卡片 -->
        <div class="profile-card" v-loading="authorChildLoading">
            <div class="profile-header">
                <img :src="author.avatar" alt="Author">
                <div class="profile-info">
                    <div class="name">{{ author.nickname }}</div>
                    <div class="level">{{ author.description }}</div>
                </div>
            </div>
            <div class="data-info">
                <div class="data-item">
                    <span class="count">{{ author.originalCount }}</span><span class="label">文章</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.fans }}</span><span class="label">粉丝</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.likeCount }}</span><span class="label">获赞</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.commentCount }}</span><span class="label">评论</span>
                </div>
            </div>
            <div class="opt-btn-box">
                <button class="btn-follow" @click="toggleFollow">
                    {{ isFollowing ? '已关注' : '关注' }}
                </button>
                <button class="btn-pm">私信</button>
            </div>
        </div>

        <!-- 目录 -->
        <div class="toc-sticky-wrapper">
            <div class="toc-box">
                <div class="sidebar-title">目录</div>
                <ul class="toc-list" v-if="tocChildItems.length > 0">
                    <li v-for="(item, index) in tocChildItems" :key="index"
                        :class="['toc-item', `level-${item.level}`, { active: item.active }]"
                        :style="{ paddingLeft: (item.level * 12) + 'px' }">
                        <a :href="`#${item.id}`" @click.prevent="scrollToHeading(item.id)">
                            {{ item.text }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 热门文章列表 -->
        <div class="recommend-box">
            <div class="sidebar-title">热门文章</div>
            <ul class="rec-list">
                <li v-for="(item, index) in hotList" :key="index">
                    <a href="#">{{ item.title }}</a>
                    <div class="rec-info">阅读 {{ item.views }}</div>
                </li>
            </ul>
        </div>

    </aside>
</script>

<!-- ================= Vue 逻辑代码 ================= -->
<script>
    // --- 组件 CSS 样式 (注入到 Head 中以保持单文件整洁) ---
    const styles = ``;

    // 动态插入样式
    const styleEl = document.createElement('style');
    styleEl.innerHTML = styles;
    document.head.appendChild(styleEl);

    // ----------------- Vue 组件定义 -----------------

    // 1. NavBar 组件
    const NavBar = {
        template: '#tpl-nav-bar',
        props: ['userAvatar'],
        data() {
            return {
                searchText: '',
                navItems: []
            }
        },
        mounted() {
            this.getNavbarList();
        },
        methods: {
            async getNavbarList() {
                try {
                    const response = await fetch(`http://blog.itbbs.com/blog/navbar/list`,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        });
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }

                    this.navItems = responseBody.data;
                } catch (error) {
                    console.error('获取导航栏出错:', error);
                }
            },
            handleSearch() {
                if(!this.searchText) return;
                alert('正在搜索：' + this.searchText);
            }
        }
    };

    // 2. LeftToolbox 组件
    const LeftToolbox = {
        template: '#tpl-left-toolbox',
        props: ['stats', 'id'],
        mounted() {
        },
        methods: {
            handleLike() {
                if (this.stats.isLiked) {
                    this.stats.likeCount--;
                    this.stats.isLiked = false;
                } else {
                    this.stats.likeCount++;
                    this.stats.isLiked = true;
                }
                this.saveLikeRecord();
            },
            async saveLikeRecord() {
                if (!this.id) return;
                try {
                    const response = await fetch(`http://blog.itbbs.com/blog/article/likeCount/${this.id}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({})
                        });
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }
                } catch (error) {
                    console.error('新增文章点赞出错:', error);
                }
            },
            async saveCollectRecord() {
                if (!this.id) return;
                try {
                    const response = await fetch(`http://blog.itbbs.com/blog/article/collectCount/${this.id}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({})
                        });
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }
                } catch (error) {
                    console.error('新增文章收藏出错:', error);
                }
            },
            handleCollect() {
                if (this.stats.isCollected) {
                    this.stats.collectCount--;
                    this.stats.isCollected = false;
                } else {
                    this.stats.collectCount++;
                    this.stats.isCollected = true;
                }
                this.saveCollectRecord();
            }
        }
    };

    // 3. RightSidebar 组件
    const RightSidebar = {
        template: '#tpl-right-sidebar',
        props: ['author', 'hotList', 'authorChildLoading', 'tocChildItems'],
        data() {
            return {
                isFollowing: false
            }
        },
        mounted() {
        },
        methods: {
            toggleFollow() {
                this.isFollowing = !this.isFollowing;
            },
            scrollToHeading(id) {
                const element = document.getElementById(id);
                if (element) {
                    // 考虑固定导航栏的高度
                    const navHeight = 50;
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - navHeight;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });

                    // 添加高亮效果
                    const originalBackground = element.style.backgroundColor;
                    element.style.backgroundColor = '#e8f4ff';
                    setTimeout(() => {
                        element.style.backgroundColor = originalBackground;
                    }, 1500);
                }
            }
        }
    };

    Vue.use(window.ELEMENT);

    // ----------------- Vue 根实例 -----------------
    new Vue({
        el: '#app',
        components: {
            'nav-bar': NavBar,
            'left-toolbox': LeftToolbox,
            'right-sidebar': RightSidebar
        },
        data() {
            return {
                // 当前登录用户数据
                currentUser: {
                    avatar: 'https://profile.itbbsimg.cn/8/7/7/2_qq_35400000'
                },

                // 文章数据
                articleStats: {
                    viewsCount: 0,
                    likeCount: 0,
                    commentCount: 0,
                    collectCount: 0,
                    isLiked: false,
                    isPayment: false
                },

                // 作者信息
                authorInfo: {
                    nickname: '',
                    avatar: '',
                    description: '',
                    originalCount: 0,
                    fans: 0,
                    likeCount: 0,
                    commentCount: 0
                },

                // 热门文章列表
                hotArticles: [],

                articleMetaLoading: false,
                authorLoading: false,

                token: null,

                // 订购相关
                subscribeBtnLoading: false,
                orderConfirmDialogVisible: false,
                orderConfirmInfo: null,

                // 目录数据
                tocItems: [],
                currentActiveId: null
            }
        },
        mounted() {
            const metaArticleId = document.querySelector('meta[name="article-id"]');
            this.articleId = metaArticleId.getAttribute('content');
            const authorId = document.querySelector('meta[name="author-id"]');
            this.authorId = authorId.getAttribute('content');
            const visibleRange = document.querySelector('meta[name="visible-range"]');
            this.visibleRange = visibleRange.getAttribute('content');
            if (!this.isNeedPayment()) {
                // 若是免费文章则默认已支付
                this.articleStats.isPayment = true;
            }
            this.isLogin = document.cookie.split('; ').find(row => row.startsWith('Is-Login='))?.split('=')[1];
            if (this.isLogin) {
                this.getUserInfo();
            }

            this.loadArticleMeta();
            this.loadAuthorInfo();
            this.increaseArticleViewsCount();

            this.$nextTick(() => {
                setTimeout(() => {
                    this.generateTOC();
                    this.setupScrollSpy();
                }, 500); // 等待内容完全渲染
            });
        },
        methods: {
            handleSubscribe() {
                this.createConfirmOrder();
            },

            // 创建确认订单
            async createConfirmOrder() {
                try {
                    this.subscribeBtnLoading = true;

                    // 获取文章价格信息
                    const priceMeta = document.querySelector('meta[name="price"]');
                    const price = parseFloat(priceMeta.getAttribute('content'));
                    const articleId = this.articleId;

                    // 构建订单确认请求数据
                    const orderConfirmData = {
                        biz: 1,  // 文章业务类型
                        orderType: 1,  // 文章付费订单
                        orderItemList: [{
                            productId: articleId,
                            productName: document.title.replace(' - ITBBS', ''),
                            productPrice: price,
                            productQuantity: 1
                        }]
                    };

                    const response = await fetch('http://order.itbbs.com/order/order/confirm', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(orderConfirmData)
                    });

                    const responseBody = await response.json();

                    if (responseBody.code !== 200) {
                        this.$message.error(responseBody.msg || '创建确认订单失败');
                        return;
                    }

                    // 显示确认订单弹窗
                    this.orderConfirmInfo = responseBody.data;
                    this.orderConfirmDialogVisible = true;

                } catch (error) {
                    console.error('创建确认订单出错:', error);
                    this.$message.error('网络错误，创建确认订单失败');
                } finally {
                    this.subscribeBtnLoading = false;
                }
            },

            // 关闭确认订单弹窗
            closeOrderConfirmDialog() {
                this.orderConfirmDialogVisible = false;
                this.orderConfirmInfo = null;
            },

            // 提交订单
            async submitOrder() {
                try {
                    if (!this.orderConfirmInfo || !this.orderConfirmInfo.confirmUuid) {
                        this.$message.error('确认订单信息不完整');
                        return;
                    }

                    // 调用提交订单接口
                    const orderSubmitData = {
                        confirmUuid: this.orderConfirmInfo.confirmUuid,
                        biz: this.orderConfirmInfo.biz,
                        orderType: this.orderConfirmInfo.orderType,
                        orderItemList: this.orderConfirmInfo.orderItemList
                    };

                    const response = await fetch('http://order.itbbs.com/order/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': document.cookie.split('; ').find(row => row.startsWith('Authorization='))?.split('=')[1] || ''
                        },
                        body: JSON.stringify(orderSubmitData)
                    });

                    const responseBody = await response.json();

                    if (responseBody.code !== 200) {
                        this.$message.error(responseBody.msg || '提交订单失败');
                        return;
                    }

                    this.$message.success('订单提交成功，正在跳转支付页面...');
                    
                    // 关闭弹窗
                    this.closeOrderConfirmDialog();
                    
                    // 重新加载文章，以显示全文
                    await this.loadArticleFullContent();
                    
                    // 更新支付状态
                    this.articleStats.isPayment = true;
                    
                } catch (error) {
                    console.error('提交订单出错:', error);
                    this.$message.error('网络错误，提交订单失败');
                }
            },
            isNeedPayment() {
                return this.visibleRange === '5';
            },
            async getUserInfo() {
                if (!this.isLogin) return;

                try {
                    const response = await fetch(`http://system.itbbs.com/system/user/current`,
                        {
                            method: 'GET',
                            credentials: 'include'
                        });
                    const responseBody = await response.json();

                    if (responseBody.code === 401) {
                        this.clearToken();
                        this.$message.warn("登录已过期，请重新登录")
                        return;
                    }

                    if (responseBody.code !== 200) {
                        this.$message.error(responseBody.msg)
                    }

                    this.currentUser = responseBody.data;
                } catch (error) {
                    console.error('获取用户信息出错:', error);
                }
            },
            clearToken() {
                document.cookie = 'Authorization=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                document.cookie = 'Is-Login=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            },
            async increaseArticleViewsCount() {
                if (!this.articleId) return;

                try {
                    const response = await fetch(`http://blog.itbbs.com/blog/article/viewsCount/${this.articleId}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({})
                        });
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }
                } catch (error) {
                    console.error('新增文章浏览量出错:', error);
                }
            },
            async loadArticleMeta() {
                if (!this.articleId || this.articleMetaLoading) return;

                try {
                    this.articleMetaLoading = true;
                    const response = await fetch(`http://blog.itbbs.com/blog/article/info/meta/${this.articleId}`);
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }

                    const data = responseBody.data;

                    // 更新统计数据
                    if (data.viewsCount !== undefined) {
                        this.articleStats.viewsCount = data.viewsCount;
                    }
                    if (data.likeCount !== undefined) {
                        this.articleStats.likeCount = data.likeCount;
                    }
                    if (data.collectCount !== undefined) {
                        this.articleStats.collectCount = data.collectCount;
                    }
                    if (data.isLiked !== undefined) {
                        this.articleStats.isLiked = data.isLiked;
                    }
                    if (data.isCollected !== undefined) {
                        this.articleStats.isCollected = data.isCollected;
                    }
                    if (this.isNeedPayment() && data.isPayment !== undefined) {
                        this.articleStats.isPayment = data.isPayment;
                        if (data.isPayment) {
                            // 调用完整内容
                            await this.loadArticleFullContent();
                        }
                    }
                } catch (error) {
                    console.error('加载文章元数据失败:', error);
                } finally {
                    this.articleMetaLoading = false;
                }
            },
            async loadArticleFullContent() {
                try {
                    this.articleMetaLoading = true;

                    const fullContentRequestPath = document.querySelector('meta[name="full-content-request-path"]');
                    const response = await fetch(fullContentRequestPath.getAttribute('content') + `article_id=${this.articleId}&biz_type=1`);
                    const responseBody = await response.json();

                    const contentElement = document.getElementById('content_views');
                    if (contentElement) {
                        contentElement.innerHTML = responseBody.content;
                    }
                } catch (error) {
                    console.error('加载完整文章内容失败:', error);
                } finally {
                    this.articleMetaLoading = false;
                }
            },
            async loadAuthorInfo() {
                if (!this.authorId || this.authorLoading) return;

                try {
                    this.authorLoading = true;
                    const response = await fetch(`http://system.itbbs.com/system/user/info/${this.authorId}`);
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }

                    const data = responseBody.data;
                    this.authorInfo = data;

                } catch (error) {
                    console.error('加载文章作者信息失败:', error);
                } finally {
                    this.authorLoading = false;
                }
            },

            // 生成嵌套结构的目录
            generateTOC() {
                const contentElement = document.getElementById('content_views');
                if (!contentElement) return;

                const headings = contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
                const tocItems = [];
                let idCounter = 1;

                // 用于跟踪层级关系
                const stack = [];

                headings.forEach((heading, index) => {
                    const level = parseInt(heading.tagName.charAt(1));
                    const text = heading.textContent.trim();

                    // 生成唯一ID
                    let id = heading.id;
                    if (!id) {
                        id = `heading-${idCounter++}`;
                        heading.id = id;
                    }

                    const tocItem = {
                        id: id,
                        text: text,
                        level: level,
                        active: false,
                        children: []
                    };

                    // 处理层级关系
                    while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                        stack.pop();
                    }

                    if (stack.length === 0) {
                        tocItems.push(tocItem);
                    } else {
                        stack[stack.length - 1].children.push(tocItem);
                    }

                    stack.push(tocItem);
                });

                // 扁平化处理以便于显示
                this.tocItems = this.flattenTOC(tocItems);
            },

            // 扁平化嵌套的目录结构
            flattenTOC(items, result = [], level = 1) {
                items.forEach(item => {
                    // 克隆对象，避免修改原结构
                    const flatItem = {
                        id: item.id,
                        text: item.text,
                        level: level,
                        active: item.active
                    };
                    result.push(flatItem);

                    // 递归处理子项
                    if (item.children && item.children.length > 0) {
                        this.flattenTOC(item.children, result, level + 1);
                    }
                });
                return result;
            },

            // 设置滚动监听
            setupScrollSpy() {
                // 使用Intersection Observer API来检测标题是否在视口中
                const observerOptions = {
                    root: null,
                    rootMargin: '-100px 0px -70% 0px', // 调整触发区域
                    threshold: 0
                };

                const observer = new IntersectionObserver((entries) => {
                    let visibleHeading = null;

                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            visibleHeading = entry.target;
                        }
                    });

                    if (visibleHeading) {
                        this.updateActiveTOCItem(visibleHeading.id);
                    }
                }, observerOptions);

                // 监听所有标题
                const headings = document.querySelectorAll('#content_views h1, #content_views h2, #content_views h3, #content_views h4, #content_views h5, #content_views h6');
                headings.forEach(heading => {
                    observer.observe(heading);
                });
            },

            // 更新当前活动的目录项
            updateActiveTOCItem(activeId) {
                this.tocItems.forEach(item => {
                    item.active = item.id === activeId;
                });
                this.currentActiveId = activeId;
            }
        }
    });
</script>
</body>
</html>