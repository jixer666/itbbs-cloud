<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="article-id" th:content="${articleId}">
    <meta name="author-id" th:content="${userId}">
    <title th:text="${title} ? ${title} + ' - ITBBS' : 'ITBBS文章'"></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>

    <style>
        /* --- 全局样式 & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, "SF UI Text", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f5f6f7;
            color: #222226;
            font-size: 14px;
            line-height: 1.5;
        }
        a { text-decoration: none; color: inherit; cursor: pointer;}
        ul { list-style: none; }
        [v-cloak] { display: none; } /* 防止 Vue 加载前闪烁 */

        /* 布局容器 */
        .main-container {
            width: 1380px;
            max-width: 100%;
            margin: 56px auto 0;
            display: flex;
            padding: 0 24px 20px;
            gap: 10px;
        }

        /* 响应式 */
        @media (max-width: 1400px) {
            .main-container, .toolbar-container { width: 1200px !important; }
            .left-toolbox { margin-left: 10px !important; position: sticky !important; top: 80px; align-self: flex-start;}
        }
        @media (max-width: 1000px) {
            .right-sidebar { display: none !important; }
            .left-toolbox { display: none !important; }
            .main-container { width: 100%; padding: 0 10px; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <!-- 顶部导航组件 -->
    <nav-bar :user-avatar="currentUser.avatar"></nav-bar>

    <div class="main-container">
        <!-- 左侧悬浮组件 -->
        <left-toolbox :stats="articleStats" v-loading="articleMetaLoading"></left-toolbox>

        <!-- 中间文章组件 -->
        <div class="article-area">
            <div class="article-title-box">
                <h1 class="title-article" th:text="${title}">文章标题</h1>
            </div>

            <div class="article-info-box">
                <div class="article-bar-top">
                  <span class="article-type-img" th:text="${type == 1 ? '原创' : (type == 2 ? '转载' : '翻译')}">
                    原创
                  </span>
                  <div class="article-copyright">
                      <span class="author-name" th:text="${userInfo.nickname}">作者名</span>
                      <span style="margin: 0 10px;">|</span>
                      <span th:text="${#dates.format(createTime, 'yyyy-MM-dd HH:mm:ss')}">发布时间</span>
                  </div>
                </div>
                <div class="read-count" v-loading="articleMetaLoading">
                    <i class="fa fa-eye"></i> <span>{{ articleStats.viewsCount }}</span> 阅读
                    <span style="margin-left:10px;"><i class="fa fa-thumbs-up"></i> <span>{{ articleStats.likeCount }}</span> 点赞</span>
                    <span style="margin-left:10px;"><i class="fa fa-heart"></i> <span>{{ articleStats.collectCount }}</span> 收藏</span>
                </div>
            </div>

            <p class="tags-row">
                文章标签：
                <span th:each="tag : ${tagDetailsList}" th:text="'#' + ${tag}" class="tag-item"></span>
            </p>

            <div id="content_views" th:utext="${content}">
                <!-- 这里会显示从数据库读取的文章内容 -->
            </div>

            <br><br>
            <hr style="border:0; border-top:1px solid #eee;">
        </div>

        <!-- 右侧侧边栏组件 -->
        <right-sidebar
                :author-child-loading="authorLoading"
                :author="authorInfo"
                :hot-list="hotArticles">
        </right-sidebar>
    </div>
</div>

<!-- ================= 组件模板定义 (x-template) ================= -->

<!-- 1. 顶部导航栏模板 -->
<script type="text/x-template" id="tpl-nav-bar">
    <nav class="itbbs-toolbar">
        <div class="toolbar-container">
            <div class="left-part">
                <div class="logo">ITBBS</div>
                <div class="nav-links">
                    <!-- 使用Vue渲染导航项 -->
                    <a v-for="item in navItems" :key="item">{{ item }}</a>
                </div>
            </div>
            <div class="search-box">
                <input type="text" v-model="searchText" placeholder="搜索博文/代码/用户..." @keyup.enter="handleSearch">
                <i class="fa fa-search search-btn" @click="handleSearch"></i>
            </div>
            <div class="user-actions">
                <a class="btn-write"><i class="fa fa-pen"></i> 创作中心</a>
                <div class="avatar">
                    <img :src="userAvatar" alt="Me">
                </div>
            </div>
        </div>
    </nav>
</script>

<!-- 2. 左侧悬浮栏模板 -->
<script type="text/x-template" id="tpl-left-toolbox">
    <aside class="left-toolbox">
        <div class="tool-item" @click="handleLike">
            <i class="fa fa-thumbs-up" :class="{active: stats.isLiked}"></i>
            <span>{{ stats.likeCount }}</span>
        </div>
        <div class="tool-item">
            <i class="fa fa-comment-dots"></i>
            <span>{{ stats.commentCount }}</span>
        </div>
        <div class="tool-item" @click="handleCollect">
            <i class="fa fa-star" :class="{active: stats.isCollected}"></i>
            <span>{{ stats.collectCount }}</span>
        </div>
        <div class="tool-item">
            <i class="fa fa-share-alt"></i>
            <span>分享</span>
        </div>
    </aside>
</script>

<!-- 3. 右侧侧边栏模板 -->
<script type="text/x-template" id="tpl-right-sidebar">
    <aside class="right-sidebar">
        <!-- 作者卡片 -->
        <div class="profile-card" v-loading="authorChildLoading">
            <div class="profile-header">
                <img :src="author.avatar" alt="Author">
                <div class="profile-info">
                    <div class="name">{{ author.nickname }}</div>
                    <div class="level">{{ author.description }}</div>
                </div>
            </div>
            <div class="data-info">
                <div class="data-item">
                    <span class="count">{{ author.originalCount }}</span><span class="label">文章</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.fans }}</span><span class="label">粉丝</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.likeCount }}</span><span class="label">获赞</span>
                </div>
                <div class="data-item">
                    <span class="count">{{ author.commentCount }}</span><span class="label">评论</span>
                </div>
            </div>
            <div class="opt-btn-box">
                <button class="btn-follow" @click="toggleFollow">
                    {{ isFollowing ? '已关注' : '关注' }}
                </button>
                <button class="btn-pm">私信</button>
            </div>
        </div>

        <!-- 热门文章列表 -->
        <div class="recommend-box">
            <div class="sidebar-title">热门文章</div>
            <ul class="rec-list">
                <li v-for="(item, index) in hotList" :key="index">
                    <a href="#">{{ item.title }}</a>
                    <div class="rec-info">阅读 {{ item.views }}</div>
                </li>
            </ul>
        </div>

        <!-- 目录-->
        <div class="toc-box">
            <div class="sidebar-title">目录</div>
            <ul class="toc-list">
                <li>1. Vue2 基础介绍</li>
                <li class="sub">1.1 数据绑定</li>
                <li class="sub">1.2 组件化</li>
                <li>2. 案例分析</li>
            </ul>
        </div>
    </aside>
</script>

<!-- ================= Vue 逻辑代码 ================= -->
<script>
    // --- 组件 CSS 样式 (注入到 Head 中以保持单文件整洁) ---
    const styles = `
            /* Navbar Styles */
            .itbbs-toolbar { height: 50px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: center; }
            .toolbar-container { width: 1380px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
            .left-part { display: flex; align-items: center; }
            .logo { font-size: 22px; font-weight: 900; color: #409EFF; margin-right: 20px; }
            .nav-links a { padding: 0 10px; color: #555; font-weight: 500; cursor: pointer; }
            .nav-links a:hover { color: #222; }
            .search-box { flex: 1; max-width: 400px; margin: 0 20px; position: relative; }
            .search-box input { width: 100%; height: 32px; border: 1px solid #ccc; border-radius: 16px; padding: 0 15px; background: #f5f6f7; outline: none; transition: 0.3s; }
            .search-box input:focus { border-color: #409EFF; background: #fff; }
            .search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; cursor: pointer; }
            .user-actions { display: flex; align-items: center; gap: 20px; }
            .btn-write { background: #409EFF; color: #fff; padding: 5px 16px; border-radius: 16px; font-size: 14px; display: flex; align-items: center; gap: 5px; cursor: pointer;}
            .avatar { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; background: #eee; }
            .avatar img { width: 100%; height: 100%; object-fit: cover; }
            .bell-icon { color: #999; }

            /* Left Toolbox */
            .left-toolbox { width: 48px; position: fixed; margin-left: -60px; top: 140px; display: flex; flex-direction: column; gap: 15px; z-index: 99; }
            .tool-item { width: 48px; height: 48px; background: #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #999; transition: 0.2s; }
            .tool-item:hover { color: #409EFF; }
            .tool-item i.active { color: #409EFF; }
            .tool-item span { font-size: 10px; }

            /* Article Area */
            .article-area { flex: 1; background: #fff; border-radius: 4px; padding: 30px; min-height: 800px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); overflow: hidden; }
            .title-article { font-size: 28px; font-weight: 700; color: #222; margin-bottom: 15px; word-break: break-all; }
            .article-info-box { background: #f8f8f8; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; color: #999abc; margin-bottom: 20px; }
            .article-bar-top { display: flex; align-items: center; gap: 15px; }
            .article-type-img { height: 20px; background: #409EFF; color: #fff; padding: 0 6px; border-radius: 2px; font-size: 12px; line-height: 20px; margin-right: 5px; }
            .author-name { color: #555; font-weight: 500; }
            .tags-row { color: #999; font-size: 12px; margin-top: 20px; margin-bottom: 30px;}
            .tag-item { background: #f0f0f5; padding: 2px 8px; border-radius: 4px; color: #555; margin-right: 5px; }

            /* Content Styles */
            #content_views { font-size: 16px; color: #222; line-height: 26px; }
            #content_views h2 { font-size: 22px; margin: 30px 0 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
            #content_views p { margin-bottom: 16px; text-align: justify; }
            #content_views pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; font-family: monospace; margin-bottom: 20px; position: relative; }
            #content_views pre::before { content: "code"; position: absolute; top: 5px; right: 10px; color: #5c6370; font-size: 12px; }

            /* Right Sidebar */
            .right-sidebar { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
            .profile-card, .recommend-box, .toc-box { background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius: 4px; padding: 16px; }
            .profile-card { padding: 20px; }
            .profile-header { display: flex; align-items: center; margin-bottom: 15px; }
            .profile-header img { width: 48px; height: 48px; border-radius: 50%; margin-right: 10px; border: 1px solid #eee; }
            .profile-info .name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
            .profile-info .level { font-size: 12px; color: #999; }
            .data-info { display: flex; justify-content: space-between; margin-bottom: 15px; }
            .data-item { text-align: center; }
            .data-item .count { display: block; font-weight: bold; font-size: 16px; }
            .data-item .label { font-size: 12px; color: #999; }
            .opt-btn-box { display: flex; gap: 10px; }
            .btn-follow { flex: 1; height: 32px; border: 1px solid #409EFF; color: #409EFF; background: #fff; border-radius: 4px; cursor: pointer; }
            .btn-follow:hover { background: #fff5f2; }
            .btn-pm { flex: 1; height: 32px; border: 1px solid #ccccd8; color: #555; background: #fff; border-radius: 4px; cursor: pointer; }

            .sidebar-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; border-left: 4px solid #409EFF; padding-left: 10px; line-height: 18px; }
            .rec-list li { margin-bottom: 12px; }
            .rec-list a { font-size: 14px; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
            .rec-list a:hover { color: #409EFF; }
            .rec-info { font-size: 12px; color: #999; margin-top: 4px; }
            .toc-list { padding-left: 10px; font-size: 13px; color: #555; }
            .toc-list li { margin-bottom: 8px; }
            .toc-list li.sub { padding-left: 15px; }
        `;
    // 动态插入样式
    const styleEl = document.createElement('style');
    styleEl.innerHTML = styles;
    document.head.appendChild(styleEl);

    // ----------------- Vue 组件定义 -----------------

    // 1. NavBar 组件
    const NavBar = {
        template: '#tpl-nav-bar',
        props: ['userAvatar'],
        data() {
            return {
                searchText: '',
                navItems: ['博客', '下载', '学习', '社区', '云服务']
            }
        },
        mounted() {
            // 从Thymeleaf传递的数据中获取导航项
            const navItemsAttr = this.$el.getAttribute('data-nav-items');
            if (navItemsAttr) {
                this.navItems = JSON.parse(navItemsAttr);
            }
        },
        methods: {
            handleSearch() {
                if(!this.searchText) return;
                alert('正在搜索：' + this.searchText);
            }
        }
    };

    // 2. LeftToolbox 组件
    const LeftToolbox = {
        template: '#tpl-left-toolbox',
        props: ['stats'],
        mounted() {
        },
        methods: {
            handleLike() {
                if (this.stats.isLiked) {
                    this.stats.likeCount--;
                    this.stats.isLiked = false;
                } else {
                    this.stats.likeCount++;
                    this.stats.isLiked = true;
                }
            },
            handleCollect() {
                if (this.stats.isCollected) {
                    this.stats.collectCount--;
                    this.stats.isCollected = false;
                } else {
                    this.stats.collectCount++;
                    this.stats.isCollected = true;
                }
            }
        }
    };

    // 3. RightSidebar 组件
    const RightSidebar = {
        template: '#tpl-right-sidebar',
        props: ['author', 'hotList', 'authorChildLoading'],
        data() {
            return {
                isFollowing: false
            }
        },
        mounted() {
        },
        methods: {
            toggleFollow() {
                this.isFollowing = !this.isFollowing;
            }
        }
    };

    Vue.use(window.ELEMENT);

    // ----------------- Vue 根实例 -----------------
    new Vue({
        el: '#app',
        components: {
            'nav-bar': NavBar,
            'left-toolbox': LeftToolbox,
            'right-sidebar': RightSidebar
        },
        data() {
            return {
                // 当前登录用户数据 - 可以用Thymeleaf传值
                currentUser: {
                    avatar: 'https://profile.itbbsimg.cn/8/7/7/2_qq_35400000'
                },

                // 文章数据
                articleStats: {
                    viewsCount: 0,
                    likeCount: 0,      
                    commentCount: 0,   
                    collectCount: 0,   
                    isLiked: false,
                },

                // 作者信息
                authorInfo: {
                    nickname: '',
                    avatar: '',
                    description: '',
                    originalCount: 0,
                    fans: 0,
                    likeCount: 0,
                    commentCount: 0
                },

                // 热门文章列表
                hotArticles: [],

                articleMetaLoading: false,
                authorLoading: false
            }
        },
        mounted() {
            const metaArticleId = document.querySelector('meta[name="article-id"]');
            this.articleId = metaArticleId.getAttribute('content');
            const authorId = document.querySelector('meta[name="author-id"]');
            this.authorId = authorId.getAttribute('content');

            this.loadArticleMeta();
            this.loadAuthorInfo();
            this.increaseArticleViewsCount();
        },
        methods: {
            async increaseArticleViewsCount() {
                if (!this.articleId) return;

                try {
                    const response = await fetch(`http://blog.itbbs.com/blog/article/viewsCount/${this.articleId}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({})
                        });
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }
                } catch (error) {
                    console.error('新增文章浏览量出错:', error);
                }
            },
            async loadArticleMeta() {
                if (!this.articleId || this.articleMetaLoading) return;

                try {
                    this.articleMetaLoading = true;
                    const response = await fetch(`http://blog.itbbs.com/blog/article/info/meta/${this.articleId}`);
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }

                    const data = responseBody.data;

                    // 更新统计数据
                    if (data.viewsCount !== undefined) {
                        this.articleStats.viewsCount = data.viewsCount;
                    }
                    if (data.likeCount !== undefined) {
                        this.articleStats.likeCount = data.likeCount;
                    }
                    if (data.collectCount !== undefined) {
                        this.articleStats.collectCount = data.collectCount;
                    }

                } catch (error) {
                    console.error('加载文章元数据失败:', error);
                } finally {
                    this.articleMetaLoading = false;
                }
            },
            async loadAuthorInfo() {
                if (!this.authorId || this.authorLoading) return;

                try {
                    this.authorLoading = true;
                    const response = await fetch(`http://system.itbbs.com/system/user/info/${this.authorId}`);
                    const responseBody = await response.json();

                    if (responseBody.code != 200) {
                        this.$message.error(responseBody.msg)
                    }

                    const data = responseBody.data;
                    this.authorInfo = data;

                } catch (error) {
                    console.error('加载文章作者信息失败:', error);
                } finally {
                    this.authorLoading = false;
                }
            },
        }
    });
</script>
</body>
</html>